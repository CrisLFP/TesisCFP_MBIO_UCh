---
title: "DEF_2.0"
author: "CFP"
format: html
editor: visual
---

```{r}
gc()
setwd("~/Desktop/U_CHILE/MG_BIOESTADÍSTICA/TESIS/DATOS PÚBLICOS/DEF_DEIS")
```

```{r}
library(tidyverse)
library(readr)
library(kableExtra)
library(summarytools)
```

# 0. Carga y administración de datos previa

```{r eval=FALSE}
## no correr otra vez, por eso el eval=F
def_1990_2021 <- read_csv("def_1990_2021.csv")
def_2022_2025 <- read_csv("def_2022_2025.csv") #considerar que estos no están verificados (validación)
```

```{r eval=F}
## no correr otra vez, por eso el eval=F
def.1 <- def_1990_2021 %>%
  ## dar formato a las variables
  mutate(
    V1 = as.numeric(V1),
    V2 = as.Date(V2),
    V3 = as.factor(V3),
    V4 = as.factor(V4),
    V5 = as.numeric(V5),
    V6 = as.numeric(V6),
    V7 = as.factor(V7),
    V8 = as.factor(V8),
    V9 = as.factor(V9),
    V10 = as.factor(V10),
    V11 = as.factor(V11),
    V12 = as.factor(V12),
    V13 = as.factor(V13),
    V14 = as.factor(V14),
    V15 = as.factor(V15),
    V16 = as.factor(V16),
    V17 = as.factor(V17)) %>%
  ## filtar las codificaciones que no corresponden a CG
  filter(V12 == "C15-C26") %>%
  filter(V9 == "C169") %>%
  ## renombrar variables
  rename(
    AÑO = V1,
    FECHA_DEF = V2,
    SEXO = V3,
    EDAD_TIPO = V4,
    EDAD = V5,
    CODIGO_COMUNA = V6,
    COMUNA = V7,
    REGION = V8,
    CODIGO_CIE10 = V9,
    CAUSA_CIE.10 = V10,
    CAUSA_DEF = V11,
    GRUPO_CIE10 = V12,
    GRUPO_CAUSA_DEF = V13,
    CATEG_DEF = V14,
    DIAG_DEF = V15,
    CATEG_CAUSA_DEF = V16,
    SUBCATEG_CAUSA_DEF = V17  ) %>%
  dplyr::select(1:17)

###################################################
def.2 <- def_2022_2025 %>%
  ## dar formato a las variables
  mutate(
    V1 = as.numeric(V1),
    V2 = as.Date(V2),
    V3 = as.factor(V3),
    V4 = as.factor(V4),
    V5 = as.numeric(V5),
    V6 = as.numeric(V6),
    V7 = as.factor(V7),
    V8 = as.factor(V8),
    V9 = as.factor(V9),
    V10 = as.factor(V10),
    V11 = as.factor(V11),
    V12 = as.factor(V12),
    V13 = as.factor(V13),
    V14 = as.factor(V14),
    V15 = as.factor(V15),
    V16 = as.factor(V16),
    V17 = as.factor(V17)     ) %>%
  ## filtar las codificaciones que no corresponden a CG
   filter(V12 == "C15-C26") %>%
   filter(V9 == "C169") %>%
  ## renombrar variables
   rename(
     AÑO = V1,
     FECHA_DEF = V2,
     SEXO = V3,
     EDAD_TIPO = V4,
     EDAD = V5,
     CODIGO_COMUNA = V6,
     COMUNA = V7,
     REGION = V8,
     CODIGO_CIE10 = V9,
     CAUSA_CIE.10 = V10,
     CAUSA_DEF = V11,
     GRUPO_CIE10 = V12,
     GRUPO_CAUSA_DEF = V13,
     CATEG_DEF = V14,
     DIAG_DEF = V15,
     CATEG_CAUSA_DEF = V16,
     SUBCATEG_CAUSA_DEF = V17) %>%
 dplyr::select(1:17)

##########################################################
## unión base de datos defunciones
defunciones <- rbind(def.1, def.2) %>% 
  filter(AÑO > 2001)
```

```{r eval = F}
## Carga de datos Servicio de Salud
ServSalud <- read_csv("ServSalud.csv") 

## crear variable SS. SOLO CORRER ESTE CHUNK TAL COMO ESTA (NO QUITAR LOS #s)
ServSalud<- ServSalud %>%
  rename(CODIGO_COMUNA = regCom,
         Servicio_salud = `Nombre Dependencia Jerárquica (SEREMI / Servicio de Salud)`) %>%
  dplyr::select(Servicio_salud, CODIGO_COMUNA, `Nombre Comuna`)

## no correr otra vez estas ultimas líneas

## unión de BBDD (ESTO YA ESTÁ HECHO)
master_def <- inner_join(defunciones, ServSalud, by = "CODIGO_COMUNA")

## Dejar esta base como .cSv (ESTO YA ESTÁ HECHO)
write_csv(master_def, "BASE_DEFUNCIONES.csv")
```

# 1. Carga y administración de datos

```{r message=F, eval = F}
## Base de datos con todas las defunciones por año y SS creada en las líneas de código previas. Como de esas solo se usará un archivo .csv, se crea en un documento aparte y se carga en vez de ejecutar todas las líneas de código previas cada vez.

master.base <- read_csv("BASE_DEFUNCIONES.csv")

## Creacion variable quinquenio (Trabajar con la variable edad y función cut)

master.base <- master.base %>%

## creaciónde la variable QUINQUENIO mediante la categorización de variable cuantitativa EDAD
  mutate(QUINQUENIO = 
           cut(EDAD,
      
## número de cortes (breaks) que se hará en la variable EDAD (RECORDAR: los breaks son siempre labels + 1)
      breaks = c(0,4,9,14,19,24,29,34,39,44,49,54,59,64,69,74,79, 115),

## etiquetas que recibirán los cortes que se realizados. Esta nomenclatura es la stantander usada por DEIS e INE.
      labels = c(
        "0-4",      #(0-4]
        "5-9",      #(5-9]
        "10-14",    #(10-14]
        "15-19",    #(15-19] 
        "20-24",    #(20-24]
        "25-29",    #(25-29]
        "30-34",    #(30-34]
        "35-39",    #(35-39]
        "40-44",    #(40-44]
        "45-49",    #(45-49]
        "50-54",    #(50-54]
        "55-59",    #(55-59]
        "60-64",    #(60- 64]
        "65-69",    #(65-69]
        "70-74",    #(70- 74]
        "75-79",    #(75-79]
        "80 y más"  #(80 y mas(
      ),
## En el intervalo más pequeño (0-4), incluir el límite inferior, de esta forma la edad 0 queda incluida.
   include.lowest = TRUE
  )
)
```

```{r message=F, eval = F}
## Reagrupar por mediana, terciles y cuartiles para no tener def = 0 en modelado
( mediana <- median(master.base$EDAD) )
( terciles <- quantile(master.base$EDAD, probs = c(1/3, 2/3)) )
( cuartiles <- quantile(master.base$EDAD, probs = c(0.25, 0.5, 0.75)) )

master.base <- master.base %>%
  mutate(
    EDAD_MEDIANA = cut (EDAD, breaks = c(0 , 72, 115), labels = c("0-72", "72 y mas"), right = T), 
    EDAD_TERCIL = cut (EDAD, breaks = c(0 , 66, 77, 115), labels = c("0-66", "67-77", "78 y más")),
    EDAD_CUARTIL = cut (EDAD, breaks = c(0 , 63, 72, 80, 115), labels = c("0-63", "64-72", "73-80", "mayor 80")),
    SEXO = factor(SEXO),
    SEXO = fct_recode(SEXO,
                           "Hombre" = "1", "Mujer" = "2"))
```

```{r eval = F}
save(master.base, file = "BASE_DEFUNCIONES.RData")
```

# 2. Defunciones brutas

```{r}
load("BASE_DEFUNCIONES.RData")
```

## 2.1 Por año y SS

```{r}
## Conteo de defunciones a causa de CG por año y SS.

def.1 <- master.base %>%
  
  ## agrupar las filas por AÑO y Servicio de salud
  group_by(AÑO, Servicio_salud) %>%
  
  ## resumir los grupos en la suma de la filas (cda defunción) de estos (grupos)
  summarise(defunciones = n()) %>%
  
  ## Ordenar las filas por los valores de la segunda columna (Servicio_salud)
  arrange(Servicio_salud) %>%  
  
  ## Ordenar el df para que la columna Servicio_salud quede en primer lugar.
  dplyr::select(Servicio_salud, everything()) %>%
  
  ## filtrar la columna AÑO_DEF conservacion las filas que no contienen estos años
  filter(!AÑO %in% c(2020, 2021, 2022, 2023, 2024, 2025)) 
```

## 2.2 Por año, SS y Sexo

```{r}
def.2 <- master.base %>%
  
  ## agrupar segpun año, sexo y SS
  group_by(AÑO, Servicio_salud, SEXO) %>%
  
  summarise(defunciones = n()) %>%
  arrange(Servicio_salud, SEXO) %>%  
  dplyr::select(Servicio_salud, everything()) %>%
  filter(!AÑO %in% c(2020, 2021, 2022, 2023, 2024, 2025))
```

## 2.3 Por año, sexo y quinquenio, según SS

```{r message=F}
def.3 <- master.base %>%
  
  ## agrupar por AÑO, servicio de salud, sexo y quinquenio
  group_by(AÑO, Servicio_salud, SEXO, QUINQUENIO) %>%
  
  summarise(defunciones = n()) %>%
  arrange(Servicio_salud, SEXO) %>%  
  dplyr::select(Servicio_salud, everything()) %>%
  filter(!AÑO %in% c(2020, 2021, 2022, 2023, 2024, 2025))
```

## 2.4 Por año, sexo y EDAD_MEDIANA, según SS

```{r eval = F}
def.4 <- master.base %>%
  
  ## agrupar por AÑO, servicio de salud, sexo y quinquenio
  group_by(AÑO, Servicio_salud, SEXO, EDAD_MEDIANA) %>%
  
  summarise(defunciones = n()) %>%
  arrange(Servicio_salud, SEXO) %>%  
  dplyr::select(Servicio_salud, everything()) %>%
  filter(!AÑO %in% c(2020, 2021, 2022, 2023, 2024, 2025))
```

## 2.5 Por año, sexo y EDAD_TERCIL, según SS

```{r}
def.5 <- master.base %>%
  
  ## agrupar por AÑO, servicio de salud, sexo y quinquenio
  group_by(AÑO, Servicio_salud, SEXO, EDAD_TERCIL) %>%
  
  summarise(defunciones = n()) %>%
  arrange(Servicio_salud, SEXO) %>%  
  dplyr::select(Servicio_salud, everything()) %>%
  filter(!AÑO %in% c(2020, 2021, 2022, 2023, 2024, 2025)) %>% 

  mutate(defunciones = ifelse(is.na(defunciones),1, defunciones))
```

## 2.6 Por año, sexo y EDAD_CUARTIL, según SS

```{r eval = F}
def.6 <- master.base %>%
  
  ## agrupar por AÑO, servicio de salud, sexo y quinquenio
  group_by(AÑO, Servicio_salud, SEXO, EDAD_CUARTIL) %>%
  
  summarise(defunciones = n()) %>%
  arrange(Servicio_salud, SEXO) %>%  
  dplyr::select(Servicio_salud, everything()) %>%
  filter(!AÑO %in% c(2020, 2021, 2022, 2023, 2024, 2025))
```

# 3. Tasas de defunción

## 3.1. Carga de datos de poblaciones

```{r}
load("~/Desktop/U_CHILE/MG_BIOESTADÍSTICA/TESIS/DATOS PÚBLICOS/PROYECCIONES_POBLACIONALES/pob_total_ss.RData")
load("~/Desktop/U_CHILE/MG_BIOESTADÍSTICA/TESIS/DATOS PÚBLICOS/PROYECCIONES_POBLACIONALES/pob_total_SEXO_ss.RData")
load("~/Desktop/U_CHILE/MG_BIOESTADÍSTICA/TESIS/DATOS PÚBLICOS/PROYECCIONES_POBLACIONALES/pob_total_QQ_SEXO_ss.RData")
load("~/Desktop/U_CHILE/MG_BIOESTADÍSTICA/TESIS/DATOS PÚBLICOS/PROYECCIONES_POBLACIONALES/pob_total_tercil_SEXO_ss.RData")
```

```{r}
data1 <- data1 %>% 
  group_by(Servicio_salud, AÑO) %>% 
  summarise(POBLACION = sum(POBLACION))

data2 <- data2 %>% 
  rename(SEXO = Sexo)

data4 <- data4 %>% 
  rename(SEXO = Sexo,
         QUINQUENIO = quinquenio)

data5 <- data5 %>% 
    rename(SEXO = Sexo)
```

## 3.2 tasa de mortalidad CG por 100.000 habitantes, por año en SS

```{r}
## tasa de defunciones de CG por 100.000 habitantes según SS
tasa.def <- left_join(def.1, data1, by = c("Servicio_salud", "AÑO"))

tasa.def  <- tasa.def %>%
  ## creación columna de tasas
  mutate(tasa =round( (defunciones / POBLACION) * 100000,2) ) %>%
  
  ## descartar columnas duplicadas
  dplyr::select(Servicio_salud, AÑO, defunciones, POBLACION, tasa)
```

## 3.3 tasas de mortalidad de CG según sexo por 100.000 habitantes por año en SS.

```{r}
## creación df con defunciones y poblacion por año y sexo
tasa.def.sexo <- left_join(def.2, data2, by = c("Servicio_salud", "AÑO", "SEXO")) %>%
  mutate(tasa =round( (defunciones / POBLACION) * 100000,2) )%>%
  dplyr::select(Servicio_salud, AÑO, SEXO, defunciones, POBLACION, tasa)
```

## 3.4 tasas de mortalidad de CG por sexo y QQ por 100.000 habitantes por año en SS

```{r}
## def.3 es el df que tiene la información de mortalidad por SS, sexo y quinquenio
tasa.def.sexo.quin.com <- left_join(def.3, data4, by = c("Servicio_salud", "SEXO", "QUINQUENIO", "AÑO")) %>% 
  mutate(tasa = round((defunciones/ POBLACION) * 100000,2))

defunciones2 <- tasa.def.sexo.quin.com %>%
  dplyr::select( Servicio_salud, AÑO, SEXO, QUINQUENIO, defunciones, POBLACION) %>%
  write_csv("defunciones2_oe2_QQ.csv")
```

```{r}
## df con las defunciones de todas las combinaciones de datos -> este es el df completo, incluyendo las categorias que no estan tienen cero obs.

## 1. obtener todas las combinaciones de variables para pirámidas
completo <- expand.grid(
  AÑO_DEF = unique(master.base$AÑO),
  Servicio_salud = unique(master.base$Servicio_salud),
  SEXO = unique(master.base$SEXO),
  QUINQUENIO = unique(master.base$QUINQUENIO) ) %>%
  rename(AÑO = AÑO_DEF)

## 2. unir df
defunciones2<- left_join(completo, tasa.def.sexo.quin.com, by = c("AÑO", "Servicio_salud", "SEXO", "QUINQUENIO"))

## 3. exportar datos para oe2
defunciones2_completo <- defunciones2 %>%
  dplyr::select( Servicio_salud, AÑO, SEXO, QUINQUENIO, defunciones) %>%
  write_csv("defunciones2_oe2_QQ_completo.csv")
```

## 3.5 tasas de mortalidad de CG por sexo y tercil por 100.000 habitantes por año en SS

```{r}
tasa.def.sexo.tercil <- left_join(def.5, data5, by = c("Servicio_salud", "SEXO", "EDAD_TERCIL", "AÑO")) %>%
  mutate(tasa =round( (defunciones / POBLACION) * 100000,2) )%>%
  dplyr::select(Servicio_salud, AÑO, SEXO, EDAD_TERCIL, defunciones, POBLACION, tasa) 

# save(tasa.def.sexo.tercil, file = "def_oe2_tercil")
```

# 4. Graficos tasas de mortalidad.

```{r fig.width=38, fig.height=25}
mortalidad.plot <- ggplot(tasa.def, # df de donde se obtienen los datos
       aes(x = AÑO,                     # eje x : variable AÑO
           y = tasa,                    # eje y: varibale tasa
           group = Servicio_salud,      # agrupar por la variables Servicio_salud
           color = Servicio_salud)) +   # color segun Servicio_salud
  geom_smooth(method = "lm",
              se = F,
              linetype = "solid",
              colour = "#8B8878",
              alpha = 0.05,
              linewidth = 0.6) +
  geom_line() +                         # Línea de incidencia por año
  geom_point() +                        # Puntos para visualizar las tasas
  facet_wrap(~ Servicio_salud, 
             scales = "free_y", # Un gráfico por servicio de salud
             ncol = 5) +  
  theme_minimal() +
  scale_x_continuous(breaks = unique(tasa.def$AÑO)) +
  theme(legend.position = "none",   # Oculta la leyenda porque cada faceta es un servicio
     panel.grid.major.y = element_line(color = "gray80"),  ## añadir linea que identifique el eje Y
     panel.grid.minor.y = element_line(color = "gray90"),  
     axis.line.y = element_line(color = "black"))+
  
  labs(title = "Tasa de mortalidad de GC por 100000 habitantes, según Servicio de Salud", 
       x = "Año", 
       y = "Tasa de mortalidad")

mortalidad.plot
ggsave("mortalidad.jpeg", mortalidad.plot, width = 38, height = 25, dpi = 300)
```

#5. Pirámides poblacionales de tasas de mortalidad por tramo, sexo, quinquenio y SS

```{r eval=F}
## eliminar filas con valores NA en df de defunciones. Esto es para fines de los gráficos. pero las salidas de datos, si necesito saber cuando es NA.
tasa.def.sexo.quin.com <- tasa.def.sexo.quin.com %>% drop_na(tasa)

## Transformar los datos para que los hombres tengan valores negativos (necesario para la gráfica)
tasa.def.sexo.quin.com$tasa_modificada <- ifelse(tasa.def.sexo.quin.com$SEXO == "Hombre", 
                                          -tasa.def.sexo.quin.com$tasa, 
                                           tasa.def.sexo.quin.com$tasa)

## Listar todos los servicios de salud y años únicos
servicios <- unique(tasa.def.sexo.quin.com$Servicio_salud)
años <- unique(tasa.def.sexo.quin.com$AÑO)

## Crear una carpeta  en la ruta de trabajo para guardar los gráficos generados
dir.create("graficos_piramides", showWarnings = FALSE)

## creación de gráfico con bucle for anidado para cada combinación de servicio y año
for (servicio in servicios) {      ## para cada servicio en el objeto servicios
  for (año in años) {              ## y para cada año en el obsejto años
    
    ## Filtrar los datos para el servicio y año específicos
       # en cada iteración de los bucles, datos_filtrados es un subconjunto filtrado por la combinación de Servicio_alud y AÑO de la iteración que este corriendo en el momento
       # subset crea un nuevo df que contienen las condiciones especificadas, es decir filtra los SS y AÑO que no correspondan el servicio y año de la iteracion que está corriendo.
    
    datos_filtrados <- subset(tasa.def.sexo.quin.com, ## elsu
                              Servicio_salud == servicio & 
                              AÑO == año)
    
    # Crear el gráfico
    p <- ggplot(data = datos_filtrados) +
      
      geom_bar(aes(x = QUINQUENIO, 
                   y = tasa_modificada, 
                   fill = SEXO), 
               stat = "identity") +
      
      scale_y_continuous(breaks = seq(-1000, 600, 30),
                         labels = abs(seq(-1000, 600, 30))) +
      
      ## voltear los ejes
      coord_flip() +
      
      ## título eje y
      ylab("Tasa de mortalidad de CG por 100000 habitantes") +
      
      ## titulo eje x
      xlab("Quinquenios de edad") +
      
      ## titulo del gráfico
      ## revisar la sintaxis de paste() para entender el código.
      # paste(x1, x2, x3..., sep = " algo ") por default sep = " " separa por un espacio
      ggtitle(paste("Piramide Poblacional:", 
                    servicio,
                    "-", # este guión se utiliza para separar el nombre del servicio y el año en el título del gráfico
                    año)) + 
      
      ## tema del gráfico
      theme_minimal() +
      
      ## especificaciones del tema
      theme(axis.title = element_text(size = 10, face = "bold"))
    
    ## Guardar los gráficos en un archivo
    ggsave(paste0("graficos_piramides/", 
                  servicio, "_", 
                  año, ".jpeg"), 
           plot = p,    ## el grafico p que está iterando
           height = 8,  ## altura del grpafico
           width = 10)  ## anchura del grpafico
  }
}
```
